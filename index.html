<script>
const API = 'https://script.google.com/macros/s/AKfycbye3RORWk2HZFBdKayrKXKMM1jACMg14YZPIhxXNVo-yuLMlYpIsQAuCIWh2IlZLRF2ZA/exec';

let stockLocal = [];        // arrays o objetos según backend
let ordenAsc = true;
let IDX = {};               // nombre encabezado -> índice real (si vienen arrays)

// Encabezados oficiales del Sheet
const HEADERS_CANON = [
  'N ANTEOJO','MARCA','MODELO','COLOR','ARMAZON','CALIBRE','CRISTAL',
  'FAMILIA','PRECIO PUBLICO','FECHA INGRESO','FECHA DE VENTA','VENDEDOR',
  'COSTO','CODIGO DE BARRAS','OBSERVACIONES','FÁBRICA'
];

// Orden visual de la tabla
const DISPLAY_ORDER = [
  'N ANTEOJO','MARCA','MODELO','COLOR','ARMAZON','CALIBRE',
  'CRISTAL','FAMILIA','PRECIO PUBLICO','FECHA DE VENTA','VENDEDOR','FECHA INGRESO'
];

// normalizador (sin tildes/espacios extra/mayúsculas)
const norm = s => String(s ?? '').normalize('NFD').replace(/[\u0300-\u036f]/g,'')
                   .replace(/\s+/g,' ').trim().toUpperCase();
const digits = v => String(v ?? '').replace(/\D+/g,'');

// sinónimos frecuentes
const SYN = {
  'N ANTEOJO': ['N° ANTEOJO','Nº ANTEOJO','N ANT','N° ANT'],
  'ARMAZON'  : ['ARMAZÓN'],
  'PRECIO PUBLICO': ['PRECIO PÚBLICO','PRECIO'],
  'FÁBRICA'  : ['FABRICA']
};

// arma el mapa nombre->índice a partir de los headers reales del Sheet
async function buildIndexMap() {
  try {
    const r = await fetch(`${API}?debug=headers`);
    const j = await r.json();
    const headers = (j && j.headers) || [];
    const map = {};
    headers.forEach((h,i)=> { map[norm(h)] = i; });

    const findIdx = (wanted) => {
      const n = norm(wanted);
      if (map[n] != null) return map[n];
      const alts = SYN[wanted] || [];
      for (const alt of alts) {
        const n2 = norm(alt);
        if (map[n2] != null) return map[n2];
      }
      return null;
    };

    IDX = {};
    HEADERS_CANON.forEach(name => {
      const idx = findIdx(name);
      if (idx != null) IDX[name] = idx;
    });

    localStorage.setItem('idxHeaders', JSON.stringify(IDX));
    return true;
  } catch (e) {
    console.warn('No pude mapear headers:', e);
    IDX = {}; return false;
  }
}

function parseFechaFlexible(v) {
  if (!v) return '';
  let d = new Date(v);
  if (!isNaN(d)) {
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yy = d.getFullYear();
    return `${dd}-${mm}-${yy}`;
  }
  if (typeof v === 'string' && /^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(v)) {
    const [dd, mm, yy] = v.split('/');
    const full = (yy.length === 2) ? ('20' + yy) : yy;
    return `${dd.padStart(2,'0')}-${mm.padStart(2,'0')}-${full}`;
  }
  return String(v);
}

// Descarga todo el stock (soporta backend viejo o nuevo) y arma IDX si hace falta
async function actualizarStock() {
  document.getElementById('spinner').style.display = 'block';
  try {
    await buildIndexMap();

    const res = await fetch(`${API}?todos=true`);
    const data = await res.json().catch(()=>null);

    // Soporta {ok, rows} o [ ... ]
    const rows = (data && Array.isArray(data.rows)) ? data.rows
               : (Array.isArray(data) ? data : null);

    if (!rows) {
      console.error('Respuesta inesperada de ?todos=true:', data);
      Swal.fire("⚠ No se pudo actualizar el stock");
      return;
    }

    stockLocal = rows;
    localStorage.setItem("stock", JSON.stringify(rows));
    const fecha = (data && data.updatedAt) || new Date().toLocaleString();
    localStorage.setItem("ultimaActualizacion", fecha);
    document.getElementById('ultimaActualizacion').textContent = "Base de datos actualizada: " + fecha;

    Swal.fire({ icon:'success', title:'Stock actualizado', showConfirmButton:false, timer: 1000 });
  } catch (e) {
    Swal.fire("❌ Error al actualizar el stock");
    console.error(e);
  } finally {
    document.getElementById('spinner').style.display = 'none';
  }
}

function ordenarPor(indice) {
  const tbody = document.getElementById('contenido');
  const filas = Array.from(tbody.querySelectorAll("tr"));
  filas.sort((a, b) => {
    const valA = a.children[indice + 1].textContent.trim();
    const valB = b.children[indice + 1].textContent.trim();
    const numA = Number(valA.replace(/[^0-9.-]/g,''));
    const numB = Number(valB.replace(/[^0-9.-]/g,''));
    if (!isNaN(numA) && !isNaN(numB)) return ordenAsc ? numA - numB : numB - numA;
    return ordenAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
  });
  ordenAsc = !ordenAsc;
  filas.forEach(fila => tbody.appendChild(fila));
}

async function buscarAnteojo() {
  const input = document.getElementById('codigo');
  const codigo = input.value.trim();
  const avanzada = document.getElementById('busquedaAvanzada').checked;
  const inicio = performance.now();
  document.getElementById('spinner').style.display = 'block';
  document.getElementById('tiempoBusqueda').textContent = '';
  document.getElementById('cantidadResultados').textContent = '';

  if (!codigo) {
    Swal.fire("Ingresá un número o palabras clave");
    document.getElementById('spinner').style.display = 'none';
    return;
  }

  // Asegurar mapa de columnas
  if (!IDX || !Object.keys(IDX).length) {
    const cached = localStorage.getItem('idxHeaders');
    if (cached) { try { IDX = JSON.parse(cached); } catch{} }
    if (!IDX || !Object.keys(IDX).length) await buildIndexMap();
  }

  const tbody = document.getElementById('contenido');
  const seleccionados = new Set();
  Array.from(tbody.querySelectorAll("tr")).forEach(fila => {
    const checkbox = fila.querySelector("input[type='checkbox']");
    if (checkbox?.checked) seleccionados.add(checkbox.dataset.id);
    else if (avanzada) fila.remove();
  });

  let resultados = [];

  // Detecto si los rows son arrays (viejo) u objetos (nuevo)
  const rowsAreArrays = stockLocal.length && Array.isArray(stockLocal[0]);

  // 1) cache: búsqueda simple por número
  if (!avanzada && /^\d+$/.test(codigo) && stockLocal.length) {
    if (rowsAreArrays) {
      const iN = IDX['N ANTEOJO'] ?? 0;
      resultados = stockLocal.filter(fila => Number(digits(fila[iN])) === Number(codigo));
    } else {
      resultados = stockLocal.filter(o => Number(digits(o['N ANTEOJO'])) === Number(codigo));
    }
  }

  // 2) si no hay local, consulto backend moderno (?todos=true&n=...)
  if (resultados.length === 0) {
    try {
      const res = await fetch(`${API}?todos=true&n=${encodeURIComponent(codigo)}`);
      const data = await res.json();
      const rows = (data && Array.isArray(data.rows)) ? data.rows
                 : (Array.isArray(data) ? data : []);
      if (rows.length) resultados = rows;
      // fallback legacy (?codigo=...) por compatibilidad
      if (!rows.length) {
        const r2 = await fetch(`${API}?codigo=${encodeURIComponent(codigo)}`);
        const d2 = await r2.json().catch(()=>[]);
        if (Array.isArray(d2)) resultados = d2;
      }
    } catch (err) { console.error(err); }
  }

  if (resultados.length === 0) {
    Swal.fire("No se encontró ningún resultado");
    document.getElementById('spinner').style.display = 'none';
    return;
  }

  renderResultados(resultados);
  document.getElementById('resultado').style.display = 'block';
  document.getElementById('cantidadResultados').textContent = `🔎 Se encontraron ${resultados.length} resultado(s).`;

  document.getElementById('spinner').style.display = 'none';
  const tiempo = (performance.now() - inicio).toFixed(2);
  document.getElementById('tiempoBusqueda').textContent = `⏱ Tiempo de búsqueda: ${tiempo} ms`;
}

function renderResultados(rows) {
  const tbody = document.getElementById('contenido');
  tbody.innerHTML = '';

  // ¿arrays u objetos?
  const arrays = Array.isArray(rows[0]);

  // indices a mostrar (si son arrays)
  const idxMostrar = DISPLAY_ORDER.map(name => IDX[name]).filter(i => i != null);
  const idxVenta   = IDX['FECHA DE VENTA'];
  const idxIngreso = IDX['FECHA INGRESO'];

  rows.forEach(fila => {
    const tr = document.createElement('tr');

    let id;
    if (arrays) {
      const iN = IDX['N ANTEOJO'] ?? 0;
      id = fila[iN];
    } else {
      id = fila['N ANTEOJO'];
    }

    // checkbox
    const tdCheck = document.createElement('td');
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.dataset.id = String(id ?? '');
    checkbox.checked = true;
    tdCheck.appendChild(checkbox);
    tr.appendChild(tdCheck);

    if (arrays) {
      idxMostrar.forEach(i => {
        const td = document.createElement('td');
        let val = (fila[i] != null && fila[i] !== "") ? fila[i] : '-';
        if (i === idxVenta || i === idxIngreso) val = parseFechaFlexible(val) || '-';
        td.textContent = val;
        tr.appendChild(td);
      });
    } else {
      DISPLAY_ORDER.forEach(key => {
        const td = document.createElement('td');
        let val = fila[key];
        const isFecha = (key === 'FECHA DE VENTA' || key === 'FECHA INGRESO');
        td.textContent = (val == null || val === '') ? '-' : (isFecha ? parseFechaFlexible(val) : String(val));
        tr.appendChild(td);
      });
    }

    tbody.appendChild(tr);
  });
}

function limpiar() {
  document.getElementById('codigo').value = '';
  document.getElementById('contenido').innerHTML = '';
  document.getElementById('resultado').style.display = 'none';
  document.getElementById('spinner').style.display = 'none';
  document.getElementById('tiempoBusqueda').textContent = '';
  document.getElementById('cantidadResultados').textContent = '';
  document.getElementById('codigo').focus();
}

window.onload = () => {
  document.getElementById('codigo').focus();
  const ultima = localStorage.getItem("ultimaActualizacion");
  const stockGuardado = localStorage.getItem("stock");
  const cachedIdx = localStorage.getItem('idxHeaders');

  if (ultima) {
    document.getElementById('ultimaActualizacion').textContent = "Base de datos actualizada: " + ultima;
  }
  if (cachedIdx) { try { IDX = JSON.parse(cachedIdx); } catch{} }
  if (stockGuardado) { try { stockLocal = JSON.parse(stockGuardado); } catch {} }

  document.getElementById("codigo").addEventListener("keydown", function(event) {
    if (event.key === "Enter") { event.preventDefault(); buscarAnteojo(); }
  });
};

// Auto-actualización diaria opcional (09:05)
setInterval(() => {
  const ahora = new Date();
  const horas = ahora.getHours();
  const minutos = ahora.getMinutes();
  const segundos = ahora.getSeconds();
  const yaActualizado = sessionStorage.getItem("stockActualizadoHoy");

  if (horas === 9 && minutos === 5 && segundos < 10 && !yaActualizado) {
    actualizarStock().then(() => {
      const ahoraStr = new Date().toLocaleString();
      document.getElementById("ultimaActualizacion").textContent =
        "🔄 Stock actualizado automáticamente: " + ahoraStr;
      sessionStorage.setItem("stockActualizadoHoy", "true");
    });
  }
}, 10000);
</script>
