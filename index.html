<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stock anteojos</title>
  <link rel="icon" type="image/png" href="logo_muy_chico_sinfondo.png" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body{font-family:Arial,sans-serif;background:#f5f5f5;padding:20px;text-align:center}
    input,button{padding:10px;margin:10px;font-size:16px}
    #spinner{display:none;font-size:18px;color:#444;margin-top:20px}
    table{margin:20px auto;border-collapse:collapse;width:95%;max-width:1100px;background:#fff;box-shadow:0 0 10px rgba(0,0,0,.1)}
    th,td{padding:10px;border:1px solid #ccc}
    th{cursor:pointer}
    th:hover{background:#f0f0f0}
    #resultado{display:none}
    #ultimaActualizacion{margin-top:10px;font-size:14px;color:#666;text-align:right;padding-right:20px}
    #tiempoBusqueda,#cantidadResultados{font-size:12px;color:#888;margin-top:5px}
    #cantidadResultados{margin-top:10px;font-size:13px;font-weight:bold}
    #busquedaAvanzadaLabel{font-size:14px;color:#333}
  </style>
</head>
<body>

<h2>
  <img src="logo_muy_chico_sinfondo.png" alt="√ìptica Cristal" style="height:24px;vertical-align:middle;margin-right:8px;">
  N√∫mero de anteojo 20-8
</h2>

<input type="text" id="codigo" placeholder="Buscar por n√∫mero o palabras clave" />
<label id="busquedaAvanzadaLabel">
  <input type="checkbox" id="busquedaAvanzada" />
  B√∫squeda avanzada
</label><br>
<button onclick="buscarAnteojo()">Buscar</button>
<button onclick="limpiar()">Limpiar</button>
<button onclick="actualizarStock()">Actualizar stock</button>

<div id="spinner">üîç Buscando...</div>
<div id="cantidadResultados"></div>

<div id="resultado">
  <table>
    <thead>
      <tr>
        <th></th>
        <th onclick="ordenarPor(0)">N¬∞ ANT</th>
        <th onclick="ordenarPor(1)">MARCA</th>
        <th onclick="ordenarPor(2)">MODELO</th>
        <th onclick="ordenarPor(3)">COLOR</th>
        <th onclick="ordenarPor(4)">ARMAZ√ìN</th>
        <th onclick="ordenarPor(5)">CALIBRE</th>
        <th onclick="ordenarPor(6)">COLOR CRISTAL</th>
        <th onclick="ordenarPor(7)">FAMILIA</th>
        <th onclick="ordenarPor(8)">PRECIO</th>
        <th onclick="ordenarPor(9)">FECHA DE VENTA</th>
        <th onclick="ordenarPor(10)">VENDEDOR</th>
        <th onclick="ordenarPor(11)">FECHA DE INGRESO</th>
      </tr>
    </thead>
    <tbody id="contenido"></tbody>
  </table>
  <div id="tiempoBusqueda"></div>
</div>

<div id="ultimaActualizacion"></div>

<script>
/** URL del Apps Script */
const API = 'https://script.google.com/macros/s/AKfycbye3RORWk2HZFBdKayrKXKMM1jACMg14YZPIhxXNVo-yuLMlYpIsQAuCIWh2IlZLRF2ZA/exec';

/** Encabezados oficiales del Sheet */
const HEADERS_CANON = [
  'N ANTEOJO','MARCA','MODELO','COLOR','ARMAZON','CALIBRE','CRISTAL',
  'FAMILIA','PRECIO PUBLICO','FECHA INGRESO','FECHA DE VENTA','VENDEDOR',
  'COSTO','CODIGO DE BARRAS','OBSERVACIONES','F√ÅBRICA'
];

/** Orden visual en la tabla (12 columnas) */
const DISPLAY_ORDER = [
  'N ANTEOJO','MARCA','MODELO','COLOR','ARMAZON','CALIBRE',
  'CRISTAL','FAMILIA','PRECIO PUBLICO','FECHA DE VENTA','VENDEDOR','FECHA INGRESO'
];

/** Fallback si NO hay ?debug=headers (orden t√≠pico que ya usabas):
 *  en el origen viene: ... PRECIO, FECHA INGRESO, FECHA DE VENTA, VENDEDOR
 */
const DEFAULT_IDX = {
  'N ANTEOJO':0,'MARCA':1,'MODELO':2,'COLOR':3,'ARMAZON':4,'CALIBRE':5,
  'CRISTAL':6,'FAMILIA':7,'PRECIO PUBLICO':8,'FECHA INGRESO':9,'FECHA DE VENTA':10,'VENDEDOR':11
};

let stockLocal = [];  // arrays (viejo) u objetos (nuevo)
let ordenAsc = true;

// Mapeos: nombre -> √≠ndice (arrays) y nombre -> clave real (objetos)
let IDX = {};
let REAL = {};

/* ------------ Normalizaci√≥n / sin√≥nimos ------------ */
const norm = s => String(s ?? '').normalize('NFD').replace(/[\u0300-\u036f]/g,'')
                   .replace(/\s+/g,' ').trim().toUpperCase();
const digits = v => String(v ?? '').replace(/\D+/g,'');
const SYN = {
  'N ANTEOJO':['N¬∞ ANTEOJO','N¬∫ ANTEOJO','N ANT','N¬∞ ANT'],
  'ARMAZON':['ARMAZ√ìN'],
  'PRECIO PUBLICO':['PRECIO P√öBLICO','PRECIO'],
  'F√ÅBRICA':['FABRICA']
};

/** Intenta traer headers desde la API; si falla, usa DEFAULT_IDX */
async function buildHeaderMaps(){
  try {
    const r = await fetch(API+'?debug=headers');
    const j = await r.json();
    const headers = (j && j.headers) || [];
    if (!Array.isArray(headers) || headers.length === 0) throw new Error('sin headers');

    const mapPos = {}, mapReal = {};
    headers.forEach((h,i)=>{ mapPos[norm(h)] = i; mapReal[norm(h)] = String(h); });

    const findIdx = (wanted) => {
      const n = norm(wanted);
      if (mapPos[n] != null) return mapPos[n];
      const alts = SYN[wanted] || [];
      for (const a of alts){ const n2 = norm(a); if (mapPos[n2] != null) return mapPos[n2]; }
      return null;
    };
    const findReal = (wanted) => {
      const n = norm(wanted);
      if (mapReal[n] != null) return mapReal[n];
      const alts = SYN[wanted] || [];
      for (const a of alts){ const n2 = norm(a); if (mapReal[n2] != null) return mapReal[n2]; }
      return wanted;
    };

    IDX = {}; REAL = {};
    HEADERS_CANON.forEach(name=>{
      const idx = findIdx(name);
      if (idx != null) IDX[name] = idx;
      REAL[name] = findReal(name);
    });

  } catch(_) {
    // fallback seguro
    IDX = {...DEFAULT_IDX};
    REAL = HEADERS_CANON.reduce((o,k)=> (o[k]=k,o),{});
  }
  // cache local
  localStorage.setItem('idxHeaders', JSON.stringify(IDX));
  localStorage.setItem('realHeaders', JSON.stringify(REAL));
}

async function ensureMaps(){
  if (!Object.keys(IDX).length || !Object.keys(REAL).length){
    const c1 = localStorage.getItem('idxHeaders');
    const c2 = localStorage.getItem('realHeaders');
    if (c1) { try { IDX = JSON.parse(c1); } catch{} }
    if (c2) { try { REAL = JSON.parse(c2); } catch{} }
  }
  if (!Object.keys(IDX).length || !Object.keys(REAL).length){
    await buildHeaderMaps();
  }
}

/* ---------------- Utils ---------------- */
function parseFechaFlexible(v){
  if (!v) return '';
  const d = new Date(v);
  if (!isNaN(d)){
    const dd=String(d.getDate()).padStart(2,'0');
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const yy=d.getFullYear();
    return `${dd}-${mm}-${yy}`;
  }
  if (typeof v==='string' && /^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(v)){
    const [dd,mm,yy]=v.split('/');
    const full = yy.length===2 ? ('20'+yy) : yy;
    return `${dd.padStart(2,'0')}-${mm.padStart(2,'0')}-${full}`;
  }
  return String(v);
}

/* ---------------- API ---------------- */
async function actualizarStock(){
  document.getElementById('spinner').style.display = 'block';
  try{
    await ensureMaps();

    const res = await fetch(API+'?todos=true');
    const data = await res.json().catch(()=>null);
    const rows = (data && Array.isArray(data.rows)) ? data.rows
               : (Array.isArray(data) ? data : null);

    if (!rows){
      Swal.fire("‚ö† No se pudo actualizar el stock");
      return;
    }

    stockLocal = rows;
    localStorage.setItem('stock', JSON.stringify(rows));

    const fecha = (data && data.updatedAt) || new Date().toLocaleString();
    localStorage.setItem('ultimaActualizacion', fecha);
    document.getElementById('ultimaActualizacion').textContent = 'Base de datos actualizada: ' + fecha;

    Swal.fire({icon:'success',title:'Stock actualizado',showConfirmButton:false,timer:1000});
  }catch(e){
    console.error(e);
    Swal.fire("‚ùå Error al actualizar el stock");
  }finally{
    document.getElementById('spinner').style.display = 'none';
  }
}

/* ---------------- Render ---------------- */
function renderResultados(rows){
  const tbody = document.getElementById('contenido');
  tbody.innerHTML = '';

  const arrays = Array.isArray(rows[0]);
  const idxMostrar = arrays ? DISPLAY_ORDER.map(n => IDX[n]).filter(i => i != null) : null;
  const idxVenta   = arrays ? IDX['FECHA DE VENTA'] : null;
  const idxIngreso = arrays ? IDX['FECHA INGRESO'] : null;
  const realKeys   = !arrays ? DISPLAY_ORDER.map(n => REAL[n] || n) : null;

  rows.forEach(row=>{
    const tr = document.createElement('tr');

    let id = arrays ? row[IDX['N ANTEOJO'] ?? 0] : row[REAL['N ANTEOJO'] || 'N ANTEOJO'];

    const tdCheck = document.createElement('td');
    const check = document.createElement('input');
    check.type='checkbox'; check.checked=true; check.dataset.id=String(id??'');
    tdCheck.appendChild(check); tr.appendChild(tdCheck);

    if (arrays){
      idxMostrar.forEach(i=>{
        const td=document.createElement('td');
        let val = (row[i] != null && row[i] !== '') ? row[i] : '-';
        if (i===idxVenta || i===idxIngreso) val = parseFechaFlexible(val) || '-';
        td.textContent = val; tr.appendChild(td);
      });
    } else {
      realKeys.forEach(key=>{
        const td=document.createElement('td');
        let val = row[key];
        const isFecha = (key===(REAL['FECHA DE VENTA']||'FECHA DE VENTA') ||
                         key===(REAL['FECHA INGRESO']||'FECHA INGRESO'));
        td.textContent = (val==null||val==='') ? '-' : (isFecha ? parseFechaFlexible(val) : String(val));
        tr.appendChild(td);
      });
    }

    tbody.appendChild(tr);
  });

  document.getElementById('resultado').style.display = 'block';
}

/* ---------------- Ordenar ---------------- */
function ordenarPor(indiceVisual){
  const tbody = document.getElementById('contenido');
  const filas = Array.from(tbody.querySelectorAll('tr'));
  filas.sort((a,b)=>{
    const A=a.children[indiceVisual+1].textContent.trim();
    const B=b.children[indiceVisual+1].textContent.trim();
    const nA=Number(A.replace(/[^0-9.-]/g,'')), nB=Number(B.replace(/[^0-9.-]/g,''));
    if(!isNaN(nA)&&!isNaN(nB)) return ordenAsc ? nA-nB : nB-nA;
    return ordenAsc ? A.localeCompare(B) : B.localeCompare(A);
  });
  ordenAsc=!ordenAsc; filas.forEach(f=>tbody.appendChild(f));
}

/* ---------------- Buscar ---------------- */
async function buscarAnteojo(){
  const input=document.getElementById('codigo');
  const codigo=String(input.value||'').trim();
  const avanzada=document.getElementById('busquedaAvanzada').checked;
  const inicio=performance.now();

  document.getElementById('spinner').style.display='block';
  document.getElementById('tiempoBusqueda').textContent='';
  document.getElementById('cantidadResultados').textContent='';

  if(!codigo){
    Swal.fire("Ingres√° un n√∫mero o palabras clave");
    document.getElementById('spinner').style.display='none';
    return;
  }

  await ensureMaps();

  let resultados=[];
  const arrays = stockLocal.length && Array.isArray(stockLocal[0]);

  // 1) local por n√∫mero
  if(!avanzada && /^\d+$/.test(codigo) && stockLocal.length){
    if (arrays){
      const iN = IDX['N ANTEOJO'] ?? 0;
      resultados = stockLocal.filter(r => Number(digits(r[iN])) === Number(codigo));
    } else {
      const kN = REAL['N ANTEOJO'] || 'N ANTEOJO';
      resultados = stockLocal.filter(r => Number(digits(r[kN])) === Number(codigo));
    }
  }

  // 2) backend moderno y legacy
  if(resultados.length===0){
    try{
      const r1 = await fetch(API+'?todos=true&n='+encodeURIComponent(codigo));
      const j1 = await r1.json();
      const rows1 = (j1 && Array.isArray(j1.rows)) ? j1.rows : (Array.isArray(j1) ? j1 : []);
      if (rows1.length) resultados = rows1;

      if (!rows1.length){
        const r2 = await fetch(API+'?codigo='+encodeURIComponent(codigo));
        const j2 = await r2.json().catch(()=>[]);
        if (Array.isArray(j2)) resultados = j2;
      }
    }catch(e){ console.error(e); }
  }

  if(resultados.length===0){
    document.getElementById('resultado').style.display='none';
    document.getElementById('cantidadResultados').textContent='No se encontraron resultados.';
    document.getElementById('spinner').style.display='none';
    return;
  }

  renderResultados(resultados);
  document.getElementById('cantidadResultados').textContent=`üîé Se encontraron ${resultados.length} resultado(s).`;
  document.getElementById('spinner').style.display='none';
  const tiempo=(performance.now()-inicio).toFixed(2);
  document.getElementById('tiempoBusqueda').textContent=`‚è± Tiempo de b√∫squeda: ${tiempo} ms`;
}

/* ---------------- Limpiar & Init ---------------- */
function limpiar(){
  document.getElementById('codigo').value='';
  document.getElementById('contenido').innerHTML='';
  document.getElementById('resultado').style.display='none';
  document.getElementById('spinner').style.display='none';
  document.getElementById('tiempoBusqueda').textContent='';
  document.getElementById('cantidadResultados').textContent='';
  document.getElementById('codigo').focus();
}

window.onload = async () => {
  await ensureMaps();
  document.getElementById('codigo').focus();

  const ultima = localStorage.getItem('ultimaActualizacion');
  if (ultima) document.getElementById('ultimaActualizacion').textContent = 'Base de datos actualizada: ' + ultima;

  const cache = localStorage.getItem('stock');
  if (cache) { try { stockLocal = JSON.parse(cache); } catch {} }

  document.getElementById('codigo').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); buscarAnteojo(); }
  });
};

/** Auto-actualizaci√≥n diaria (09:05) */
setInterval(() => {
  const ahora=new Date();
  if(ahora.getHours()===9 && ahora.getMinutes()===5 && ahora.getSeconds()<10 && !sessionStorage.getItem('stockActualizadoHoy')){
    actualizarStock().then(()=>{
      const ts=new Date().toLocaleString();
      document.getElementById('ultimaActualizacion').textContent='üîÑ Stock actualizado autom√°ticamente: '+ts;
      sessionStorage.setItem('stockActualizadoHoy','true');
    });
  }
},10000);
</script>

</body>
</html>
